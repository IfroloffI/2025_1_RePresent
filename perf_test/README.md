# Отчет по нагрузочному тестированию

## Цель

Проверить производительность API `signup` и `login`, выявить узкие места, провести оптимизацию.

## Инструменты

- **Язык**: Go (для генерации пользователей и отправки запросов)
- **Vegeta**: [github.com/tsenart/vegeta](https://github.com/tsenart/vegeta) (нагрузочное тестирование)
- **База данных**: PostgreSQL + Redis (Сессии, упор в тестировании на PostgreSQL auth_user таблицу)
- **Хостинг**: VK Cloud VPS (1 vCPU, 4 GB RAM)

## API под нагрузкой

- `POST /api/v1/auth/signup` — регистрация
- `POST /api/v1/auth/login` — вход

## Архитектура базы данных

- **Основная таблица**: `auth_user`
  - Содержит уникальные поля: `username`, `email`
  - Пароль хранится в `BYTEA` (bcrypt hash)
- **Индексы**: только на внешние ключи, отсутствуют на `username`, `email`

## Результаты тестирования

### Тестовый сценарий 1: Регистрация — нагрузка 100 rps

**Цель**: Проверить устойчивость /api/v1/auth/signup при средней нагрузке.

**Нагрузка**:

```bash
vegeta attack -rate=100 -duration=60s -connections=10 -max-connections=100 -max-workers=100
```

**Результаты**:

- Успешных запросов: 98.92%
- Всего запросов: 5371
- Пропускная способность: 81.47 req/s
- Средняя задержка: 1.08s
- 95-й перцентиль: 1.295s

**Ошибки**:

- 58 соединений закрыты хостом
- 1 — 400 Bad Request (Вероятно, ошибка генерации одной записи)

**Вывод**: Сервис стабилен при 100 rps, высокий процент успеха. Возможны локальные проблемы с соединениями или дедлайнами.

### Тестовый сценарий 2: Авторизация — нагрузка 100 rps

**Цель**: Проверка стабильности /api/v1/auth/login при средней нагрузке.

**Нагрузка**:

```bash
vegeta attack -rate=100 -duration=60s -connections=10 -max-connections=100 -max-workers=100
```

**Результаты**:

- Успешных запросов: 87.43%
- Всего запросов: 6000
- Пропускная способность: 64.3 req/s
- Средняя задержка: 503.4ms
- 95-й перцентиль: 352.9ms

**Ошибки**:

- 69 закрытых соединений
- 685 — 400 Bad Request

**Вывод**: При умеренной нагрузке login-эндпоинт показывает хорошую устойчивость, но возможны ошибки парсинга/валидации входных данных.

### Тестовый сценарий 3: Регистрация — нагрузка 1000 rps

**Цель**: Стресс-тестирование /signup при высокой нагрузке.

**Нагрузка**:

```bash
vegeta attack -rate=1000 -duration=60s -connections=100 -max-connections=1000 -max-workers=1000
```

**Результаты**:

- Успешных запросов: 13.75%
- Всего запросов: 17216
- Пропускная способность: 37.45 req/s
- Средняя задержка: 3.53s
- 95-й перцентиль: 8.0s

**Ошибки**:

- 652 разрывов соединения
- 14196 — 400 Bad Request

**Вывод**: При 1000 rps сервис явно перегружен — высокий уровень ошибок, потеря соединений. Необходимо масштабирование или оптимизация работы с БД/очередями.

### Тестовый сценарий 4: Авторизация — нагрузка 1000 rps

**Цель**: Стресс-тест /login при пиковой нагрузке.

**Нагрузка**:

```bash
vegeta attack -rate=1000 -duration=60s -connections=100 -max-connections=1000 -max-workers=1000
```

**Результаты**:

- Успешных запросов: 3.98%
- Всего запросов: 45425
- Пропускная способность: 25.29 req/s
- Средняя задержка: 1.33s
- 95-й перцентиль: 2.56s

**Ошибки**:

- 732 соединения закрыты хостом
- 42883 — 400 Bad Request

**Вывод**: Сервис не справляется с 1000 rps — почти весь трафик падает с ошибками. Необходима переработка механизма аутентификации или горизонтальное масштабирование.

## Общие замечания

**Бутылочные горлышки**:

- Обработка 400 Bad Request указывает на неустойчивость к повторным/невалидным данным
- Частые context deadline exceeded — истечение таймаута из-за долгой обработки запроса или перегрузки БД

**Выводы**:

- Использовать кеширование и очереди
- Добавить механизм ретраев и лимитирования

## Bottleneck

Основные задержки:

1. Частые обращения к БД при проверке/создании пользователей
2. Отсутствие индекса по email/username
3. Синхронная запись логов
4. Дорогостоящие операции bcrypt хеширования

## Оптимизация

- [] Добавить индекс по email/username
- [] Настроить пул соединений к БД
- [] Асинхронная запись логов
- [] Лимитирование операций хеширования
- [] Смена алгоритма хеширование (например: **Argon2id**)
- [] Увеличить таймауты сервера/клиента

## Результаты 2 итерации

(После оптимизаций)
...

## Выводы

- После оптимизации RPS вырос на X%
- Основная задержка — bcrypt хэширование пароля
- База выдерживает Y пользователей/сек без деградации
